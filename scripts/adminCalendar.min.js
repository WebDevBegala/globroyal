var gameTypes = ["B2", "B3", "B4", "B5", "B6", "B7", "D1", "D2"];
var daysName = [""]
var gHours = [];
var allDays = [];
var freeDays = [];
var date;
var gDay;
var betweenDate = [];
function getScheduleRendered() {
setTimeout(() => {


    if (sessionStorage.date) {
        let d = new Date(sessionStorage.date)
        let year = d.getFullYear();
        let month = (d.getMonth() < 9 ? "0" + Number(d.getMonth() + 1) : Number(d.getMonth() + 1));
        let day = d.getDate() < 9 ? "0" + d.getDate() : d.getDate();
        let dayString = d.getDay() == 0 ? 6 : Math.abs(d.getDay() - 1)
        let dateString = year + "-" + month + "-" + day;
        date = dateString
        $("#newdate").val(dateString);
        let i = 0;
        while (i < daysOff.length && daysOff[i] != date) {
            i++;
        }
        if (daysOff[i] != date) {
            selectDay(d.getDate())
        }
        else {
            $(".calendar-content").addClass("calendar-times").removeClass("calendar-content");
            $(".calendar-times").text("Szabadnap");

        }

        $("#current-day").text(days[dayString]);
    }
    else {
        let d = new Date()
        let year = d.getFullYear();
        let month = (d.getMonth() < 9 ? "0" + Number(d.getMonth() + 1) : Number(d.getMonth() + 1));
        let day = d.getDate() < 9 ? "0" + d.getDate() : d.getDate();
        let dayString = d.getDay() == 0 ? 6 : Math.abs(d.getDay() - 1)
        let dateString = year + "-" + month + "-" + day;
        date = dateString
        $("#newdate").val(dateString);
        let i = 0;
        while (i < daysOff.length && daysOff[i] != date) {
            i++;
        }
        if (daysOff[i] != date) {
            selectDay(d.getDate())
        }
        else {
            $(".calendar-content").addClass("calendar-times").removeClass("calendar-content");
            $(".calendar-times").text("Szabadnap");

        }
        $("#currentDate").text(dateString);
        $("#current-day").text(days[dayString]);
    }
}, 100);


}






function renderDays(year, month) {
    var calendarContent = $(".calendar-content");
    $(".calendar-content").html("")
    let d = new Date(year, month, 0)
    for (let i = 1; i < d.getDate() + 1; i++) {

        $(".calendar-content").append(`
    <div class="c-block" onclick="selectDay(`+ i + `)" ><p style="margin:0.5em" >` + i + `</p></div>
    `)
    }
}

const selectDay = (dayI) => {

    let d = new Date(date || sessionStorage.date)

    let year = d.getFullYear();
    let month = (d.getMonth() < 9 ? "0" + (d.getMonth() + 1) : d.getMonth() + 1)
    let day = d.getDate() < 9 ? "0" + Number(d.getDate()) : Number(d.getDate());
    let dateString = year + "-" + month + "-" + day
    date = dateString

    $(".calendar-content").html("")
    $(".calendar-content").addClass("calendar-times").removeClass("calendar-content");
    getFreePos(date)
    getOpenHoursWithParam(d.getDay())

}

function selectDayOther(date) {
    $(".calendar-times").html("");
    $(".calendar-content").html("")
    $(".calendar-content").addClass("calendar-times").removeClass("calendar-content");
    getFreePos(date)
    getOpenHoursWithParam(date.getDay())
}

function getOpenHours(date) {
    gHours = []

    let d = new Date();

    $.post(apiUrl + "getOpenHours.php",
        {
            day: d.getDay()
        },
        (res, status) => {

            //let data = JSON.parse(res);
            let start = Number(res.opening);
            let end = res.closing
            let diff;
            if (start > end) {
                diff = (24 - Number(start)) + Number(end);
            }
            else {
                diff = end - start
            }

            for (let i = 0; i < diff; i += 2) {
                let d = new Date();
                d.setHours(Number(start) + i)

                let hours = d.getHours()
                gHours.push(hours)

            }
        }
    )
}

function back() {
    let d = new Date()
    let year = d.getFullYear();
    let month = d.getMonth()
    let day = d.getDate();
    $(".calendar-times").html("")
    $(".calendar-times").addClass("calendar-content").removeClass("calendar-times");
    renderDays(year, month);
}



function getFreePos(date) {

    $.ajax({
        type: "POST",
        url: apiUrl + "getAdminReservations.php",
        data: "data=" + JSON.stringify({ date: date }),
        dataType: "JSON",
        success: function (response) {

            let array = [];
            for (let i = 0; i < response.length; i++) {
                array.push({
                    time: Number(response[i].time),
                    name: (response[i].name),
                    email: (response[i].email),
                    phone: (response[i].phone),
                    gameType: response[i].gameType,
                    coupon: response[i].coupon,
                    desc: response[i].desc,
                    free: response[i].free,
                    rank: response[i].rank
                })
            }

            generateDay(array)
        },
        error: function (err) {
            console.log(err)
        }

    });

}

function generateDay(otherArray) {

    setTimeout(function () {
        let array = []
        for (let i = 0; i < gHours.length; i++) {
            for (let j = 0; j < gameTypes.length; j++) {
                array.push({
                    time: gHours[i],
                    gameType: gameTypes[j]
                })
            }
        }

        generateFreeDays(array, otherArray)

    }, 100)

}

function generateFreeDays(allArray, freeArray) {
    freeDays = [];

    let array = allArray
    for (let i = 0; i < allArray.length; i++) {
        for (let j = 0; j < freeArray.length; j++) {
            if (array[i].gameType == freeArray[j].gameType
                && array[i].time == freeArray[j].time) {
                array[i].free = false
                array[i].name = freeArray[j].name
                array[i].email = freeArray[j].email
                array[i].phone = freeArray[j].phone
                array[i].coupon = freeArray[j].coupon
                array[i].desc = freeArray[j].desc
                array[i].rank = freeArray[j].rank



            }
        }
    }
    freeDays = array

    generateHtml()
}

function generateHtml() {
    $(".calendar-times").html("")
    $(".times-table").html("")
    if (gHours.length == 0) {
        $(".calendar-times").html("<h3>Ma zárva van</h3>")
    }
    else {
        for (let i = 0; i < gHours.length; i++) {

            if (Number(gHours[i] + 1) == 25) {
                $(".calendar-times").append(`
                <div class="times-table">
                    <div class="time">
                        <p>`+ gHours[i] + `:00  -  02:00</p>
                    </div>
                 </div>`);
            } else {
                $(".calendar-times").append(`
                <div class="times-table">
                    <div class="time">
                        <p>`+ gHours[i] + `:00  - ` + Number(gHours[i] + 2) + `:00</p>
                    </div>
                 </div>`);
            }





        }
        for (let i = 0; i < gHours.length; i++) {

            freeDays.forEach((e, j) => {
                if (Number(e.time) === Number(gHours[i])) {
                    if (e.free == false) {
                        switch (Number(e.rank)) {
                            case 1:
                                if (e.gameType.substr(0, 1) == "B") {
                                    if (e.coupon) {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:#00ff71;border:3px solid red' title='Név: " + e.name + "' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    } else {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:#00ff71' title='Név: " + e.name + "' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    }

                                }
                                else {
                                    if (e.coupon) {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:#6be0b5;border:3px solid red' title='Név: " + e.name + "' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    } else {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:#6be0b5' title='Név: " + e.name + "' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    }

                                }

                                break;
                            case 2:
                                if (e.gameType.substr(0, 1) == "B") {
                                    if (e.coupon) {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:lightblue;border:3px solid red' title='Név: " + e.name + "' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    } else {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:lightblue' title='Név: " + e.name + "' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    }

                                }
                                else {
                                    if (e.coupon) {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:#9b8fe0;border:3px solid red' title='Név: " + e.name + "' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    } else {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:#9b8fe0' title='Név: " + e.name + "' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    }

                                }

                                break;
                            case 3:
                                if (e.name == "VIP") {
                                    $(".times-table:nth-child(" + (i + 1) + ")").append(
                                        "<div style = 'background-color:gold' class= 'game-type' onclick='vipInfo(" + j + ")'>" +
                                        "<p>" + e.gameType + "</p>" +
                                        "</div > ")
                                } else {
                                    if (e.coupon) {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:#fdff87;border:3px solid red' title='Név: " + e.name + "' class= 'game-type' onclick='vipInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    }
                                    else {
                                        $(".times-table:nth-child(" + (i + 1) + ")").append(
                                            "<div style = 'background-color:#fdff87' title='Név: " + e.name + "' class= 'game-type' onclick='vipInfo(" + j + ")'>" +
                                            "<p>" + e.gameType + "</p>" +
                                            "</div > ")
                                    }

                                }

                            default:
                                break;
                        }

                        // $(".times-table:nth-child(" + (i + 1) + ")").append(
                        //     "<div style = 'background-color:red' class= 'game-type' onclick='getScheduleInfo(" + j + ")'>" +
                        //     "<p>" + e.gameType + "</p>" +
                        //     "</div > ")

                    }
                    else {
                        $(".times-table").eq(i).append(
                            "<div class= 'game-type' onclick='setAdminSchedule(" + j + ")' >" +
                            "<p>" + e.gameType + "</p>" +
                            "</div > ")
                    }
                }
            });
        }
    }
}

$(".game-type").click(function (e) {
    e.preventDefault();

});
let index;
function getScheduleInfo(j) {
    $(".settings-panel").css("display", "flex");
    index = j;
    adminGameData = freeDays[index]
    let data = freeDays[j];
    $("#newGameType").val(data.gameType)
    $(".schedule-info").css("display", "flex")
    $("#scheduled-info-text").html(`
        Név: ${data.name} <br>
        Email: ${data.email} <br>
        Telefon: ${data.phone} <br>
        Megjegyzés: ${data.desc} <br>
        Kupon kód: ${data.coupon}
    `)

}

function closeAdminForm() {
    $(".schedule-info").css("display", "none");
    closePanel()
}

function getOpenHoursWithParam(date) {
    gHours = []

    $.post(apiUrl + "getOpenHours.php",
        {
            day: date
        },
        (res, status) => {

            //let data = JSON.parse(res);
            let start = Number(res.opening);
            let end = res.closing
            let diff;
            if (start > end) {
                diff = (24 - Number(start)) + Number(end);
            }
            else {
                diff = end - start
            }

            for (let i = 0; i < diff; i += 2) {
                let d = new Date();
                d.setHours(Number(start) + i)

                let hours = d.getHours()
                gHours.push(hours)

            }
        }
    )
}


function changeCurrentDate(dayCh) {

    let newDate = new Date(date)
    let cd = newDate.addDays(dayCh);

    let year = cd.getFullYear();
    let month = (cd.getMonth() < 9 ? "0" + Number(cd.getMonth() + 1) : Number(cd.getMonth() + 1));
    let day = cd.getDate() < 9 ? "0" + cd.getDate() : cd.getDate();
    let dayString = cd.getDay() == 0 ? 6 : Math.abs(cd.getDay() - 1)

    $("#current-day").text(days[dayString]);
    let dateString = year + "-" + month + "-" + day;
    date = dateString;
    let i = 0;
    while (i < daysOff.length && daysOff[i] != dateString) {
        i++;
    }
    if (daysOff[i] != dateString) {
        getFreePos(dateString);
        getOpenHoursWithParam(cd.getDay())
    } else {
        $(".calendar-times").text("Szabadnap");

    }

    $("#currentDate").text(dateString)
    $("#newdate").val(dateString);
    sessionStorage.date = date

}


function gohome() {
    let newD = new Date();
    let year = newD.getFullYear();
    let month = (newD.getMonth() < 9 ? "0" + Number(newD.getMonth() + 1) : Number(newD.getMonth() + 1));
    let day = newD.getDate() < 9 ? "0" + newD.getDate() : newD.getDate();

    let dateString = year + "-" + month + "-" + day;
    date = dateString;
    let dayString = newD.getDay() == 0 ? 6 : Math.abs(newD.getDay() - 1)

    $("#current-day").text(days[dayString]);
    let i = 0;
    while (i < daysOff.length && daysOff[i] != dateString) {
        i++;
    }
    if (daysOff[i] != dateString) {
        getFreePos(dateString);
        getOpenHoursWithParam(newD.getDay())
    } else {
        $(".calendar-times").text("Szabadnap");

    }

    $("#currentDate").text(dateString)
    $("#newdate").val(dateString);
    sessionStorage.date = date
}

Date.prototype.addDays = function (days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
}